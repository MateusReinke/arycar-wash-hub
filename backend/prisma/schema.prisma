generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  STAFF
}

enum WorkOrderStatus {
  CREATED
  IN_PROGRESS
  READY
  DELIVERED
  CANCELLED
}

enum MediaType {
  ENTRY_VIDEO_EXTERNAL
  ENTRY_VIDEO_INTERNAL
  ENTRY_DETAIL_PHOTO
  DELIVERY_VIDEO
}

enum WorkOrderEventType {
  CREATED
  STATUS_CHANGED
  MEDIA_ADDED
  NOTE_UPDATED
  CANCELLED
}

enum NotificationType {
  STARTED
  READY
}

enum NotificationChannel {
  MOCK
  WHATSAPP
  SMS
}

enum NotificationStatus {
  QUEUED
  SENT
  FAILED
}

model User {
  id           String   @id @default(uuid())
  name         String
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         UserRole
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  createdOrders WorkOrder[] @relation("created_by")
  cancelledOrders WorkOrder[] @relation("cancelled_by")
  mediaCreated  Media[]
  events        WorkOrderEvent[]

  @@map("users")
}

model Customer {
  id        String   @id @default(uuid())
  phone     String   @unique
  name      String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  vehicles  Vehicle[]
  orders    WorkOrder[]

  @@map("customers")
}

model Vehicle {
  id         String   @id @default(uuid())
  plate      String   @unique
  customerId String   @map("customer_id")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  customer   Customer @relation(fields: [customerId], references: [id])
  orders     WorkOrder[]

  @@index([plate])
  @@map("vehicles")
}

model ServiceCatalog {
  id        String   @id @default(uuid())
  name      String   @unique
  priceCents Int?    @map("price_cents")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  orderLinks WorkOrderService[]

  @@map("service_catalog")
}

model WorkOrder {
  id          String         @id @default(uuid())
  code        String         @unique
  vehicleId   String         @map("vehicle_id")
  customerId  String         @map("customer_id")
  status      WorkOrderStatus
  notes       String?
  createdById String         @map("created_by")
  cancelledById String?      @map("cancelled_by")

  startedAt   DateTime?      @map("started_at")
  readyAt     DateTime?      @map("ready_at")
  deliveredAt DateTime?      @map("delivered_at")
  cancelledAt DateTime?      @map("cancelled_at")

  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")

  vehicle     Vehicle        @relation(fields: [vehicleId], references: [id])
  customer    Customer       @relation(fields: [customerId], references: [id])

  createdBy   User           @relation("created_by", fields: [createdById], references: [id])
  cancelledBy User?          @relation("cancelled_by", fields: [cancelledById], references: [id])

  services    WorkOrderService[]
  media       Media[]
  events      WorkOrderEvent[]
  notifications NotificationLog[]

  @@index([status, createdAt])
  @@map("work_orders")
}

model WorkOrderService {
  id          String @id @default(uuid())
  workOrderId String @map("work_order_id")
  serviceId   String @map("service_id")
  quantity    Int    @default(1)

  workOrder   WorkOrder      @relation(fields: [workOrderId], references: [id])
  service     ServiceCatalog @relation(fields: [serviceId], references: [id])

  @@unique([workOrderId, serviceId])
  @@map("work_order_services")
}

model Media {
  id         String   @id @default(uuid())
  workOrderId String  @map("work_order_id")
  type       MediaType
  bucket     String
  objectKey  String   @map("object_key")
  mimeType   String   @map("mime_type")
  sizeBytes  BigInt   @map("size_bytes")
  caption    String?
  createdById String @map("created_by")
  createdAt  DateTime @default(now()) @map("created_at")

  workOrder  WorkOrder @relation(fields: [workOrderId], references: [id])
  createdBy  User      @relation(fields: [createdById], references: [id])

  @@index([workOrderId, type])
  @@map("media")
}

model WorkOrderEvent {
  id         String   @id @default(uuid())
  workOrderId String  @map("work_order_id")
  type       WorkOrderEventType
  fromStatus WorkOrderStatus? @map("from_status")
  toStatus   WorkOrderStatus? @map("to_status")
  message    String?
  actorUserId String @map("actor_user_id")
  createdAt  DateTime @default(now()) @map("created_at")

  workOrder  WorkOrder @relation(fields: [workOrderId], references: [id])
  actor      User      @relation(fields: [actorUserId], references: [id])

  @@map("work_order_events")
}

model NotificationLog {
  id          String @id @default(uuid())
  workOrderId String @map("work_order_id")
  type        NotificationType
  channel     NotificationChannel
  toPhone     String @map("to_phone")
  payloadJson Json   @map("payload_json")
  providerMessageId String? @map("provider_message_id")
  status      NotificationStatus
  error       String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  workOrder   WorkOrder @relation(fields: [workOrderId], references: [id])

  @@index([workOrderId, type])
  @@map("notification_log")
}
